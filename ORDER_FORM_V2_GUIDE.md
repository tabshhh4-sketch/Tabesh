# فرم سفارش نسخه ۲ (Order Form V2) - راهنمای کامل

## مقدمه

فرم سفارش نسخه ۲ (`[tabesh_order_form_v2]`) یک پیاده‌سازی پیشرفته از فرم ثبت سفارش با قابلیت **Dynamic Dependency Mapping** است که به صورت هوشمند گزینه‌های مجاز را بر اساس انتخاب‌های قبلی کاربر فیلتر می‌کند.

## تفاوت‌های کلیدی با نسخه ۱

| ویژگی | نسخه ۱ (`[tabesh_order_form]`) | نسخه ۲ (`[tabesh_order_form_v2]`) |
|-------|-------------------------------|----------------------------------|
| **موتور قیمت‌گذاری** | ضرایب ثابت (Coefficients) | ماتریس قیمت‌گذاری (V2 Matrix) |
| **فیلتر گزینه‌ها** | استاتیک - همه گزینه‌ها نمایش داده می‌شوند | پویا - فقط گزینه‌های مجاز نمایش داده می‌شوند |
| **اعتبارسنجی محدودیت‌ها** | در پایان (قبل از ثبت) | لحظه‌ای (در هر مرحله) |
| **عملکرد** | تعداد فیلدهای زیاد | فقط فیلدهای مرتبط نمایش داده می‌شوند |
| **تجربه کاربری** | فرم طولانی با تمام گزینه‌ها | فرم آبشاری (Cascading) مرحله‌به‌مرحله |

## پیش‌نیازها

### ۱. فعالسازی موتور قیمت‌گذاری V2

ابتدا باید موتور قیمت‌گذاری نسخه ۲ را فعال کنید:

1. به پنل مدیریت WordPress بروید
2. به `تنظیمات تابش` > `قیمت‌گذاری محصول` بروید
3. گزینه `فعالسازی موتور قیمت‌گذاری نسخه ۲` را علامت بزنید
4. تغییرات را ذخیره کنید

### ۲. پیکربندی ماتریس قیمت

حداقل یک قطع کتاب باید در ماتریس قیمت پیکربندی شده باشد:

1. به `قیمت‌گذاری محصول` بروید
2. یک قطع کتاب را انتخاب کنید (مثلاً A5، رقعی، وزیری)
3. قیمت‌ها و محدودیت‌ها را تنظیم کنید:
   - نوع کاغذها و گرماژها
   - نوع صحافی‌ها
   - گرماژ جلدها
   - خدمات اضافی
   - محدودیت‌های متقاطع (forbidden combinations)
4. ذخیره کنید

## استفاده از Shortcode

### روش ساده

کافی است shortcode زیر را در محتوای صفحه یا پست خود قرار دهید:

```
[tabesh_order_form_v2]
```

### پیاده‌سازی در قالب (Theme)

اگر می‌خواهید فرم را به صورت مستقیم در فایل‌های قالب نمایش دهید:

```php
<?php echo do_shortcode('[tabesh_order_form_v2]'); ?>
```

## معماری فنی

### جریان داده (Data Flow)

```
┌─────────────────┐
│ انتخاب قطع کتاب │
└────────┬────────┘
         │
         ▼
┌────────────────────────────────┐
│ AJAX → /get-allowed-options    │
│ با book_size                   │
└────────┬───────────────────────┘
         │
         ▼
┌──────────────────────────────┐
│ نمایش انواع کاغذ مجاز        │
│ (از ماتریس قیمت فیلتر شده)  │
└────────┬─────────────────────┘
         │
         ▼
┌─────────────────────┐
│ انتخاب نوع کاغذ     │
└────────┬────────────┘
         │
         ▼
┌───────────────────────────────┐
│ نمایش گرماژهای مجاز آن کاغذ  │
└────────┬──────────────────────┘
         │
         ▼
    [ادامه جریان...]
         │
         ▼
┌────────────────────────────┐
│ محاسبه قیمت نهایی          │
│ AJAX → /calculate-price    │
└────────────────────────────┘
```

### REST API Endpoints

فرم V2 از endpoint‌های زیر استفاده می‌کند:

#### 1. `/wp-json/tabesh/v1/get-allowed-options`

**نوع:** POST

**ورودی:**
```json
{
  "book_size": "A5",
  "current_selection": {
    "paper_type": "تحریر",
    "binding_type": "شومیز"
  }
}
```

**خروجی:**
```json
{
  "success": true,
  "data": {
    "book_size": "A5",
    "allowed_papers": [
      {
        "type": "تحریر",
        "slug": "tahrir",
        "weights": [
          {"weight": "70", "slug": "tahrir-70"},
          {"weight": "80", "slug": "tahrir-80"}
        ]
      }
    ],
    "allowed_bindings": [...],
    "allowed_print_types": [...],
    "allowed_cover_weights": [...],
    "allowed_extras": [...]
  }
}
```

#### 2. `/wp-json/tabesh/v1/calculate-price`

**نوع:** POST

**ورودی:**
```json
{
  "book_size": "A5",
  "paper_type": "تحریر",
  "paper_weight": "70",
  "print_type": "bw",
  "page_count": 200,
  "quantity": 100,
  "binding_type": "شومیز",
  "cover_weight": "250",
  "extras": ["لب گرد", "شیرینک"]
}
```

**خروجی:**
```json
{
  "success": true,
  "data": {
    "price_per_book": 15000,
    "quantity": 100,
    "total_price": 1500000,
    "breakdown": {
      "page_cost": 10000,
      "binding_cost": 3000,
      "extras_cost": 2000
    },
    "pricing_engine": "v2_matrix"
  }
}
```

#### 3. `/wp-json/tabesh/v1/validate-combination`

**نوع:** POST

برای اعتبارسنجی نهایی ترکیب پارامترها قبل از ثبت سفارش.

### Caching Strategy

برای بهبود عملکرد، فرم V2 از استراتژی‌های زیر استفاده می‌کند:

1. **Client-side Cache:** نتایج API در JavaScript cache می‌شوند
2. **WordPress Object Cache:** نتایج `get_allowed_options` با TTL 5 دقیقه cache می‌شوند

```php
// کد مثال در REST endpoint
$cache_key = 'tabesh_allowed_options_' . md5( wp_json_encode( $params ) );
wp_cache_set( $cache_key, $options, 'tabesh', 300 ); // 5 minutes
```

## سفارشی‌سازی

### تغییر استایل‌های CSS

فایل استایل: `assets/css/order-form-v2.css`

می‌توانید با افزودن CSS سفارشی در قالب خود، ظاهر فرم را تغییر دهید:

```css
/* در فایل style.css قالب خود */
.tabesh-order-form-v2 .tabesh-form-title {
    color: #your-color;
    font-size: 2rem;
}

.tabesh-price-display-v2 {
    background: linear-gradient(135deg, #your-color1 0%, #your-color2 100%);
}
```

### تغییر رفتار JavaScript

فایل اسکریپت: `assets/js/order-form-v2.js`

برای افزودن event handler سفارشی:

```javascript
jQuery(document).ready(function($) {
    // اضافه کردن event handler سفارشی
    $(document).on('tabesh:price-calculated', function(e, data) {
        console.log('قیمت محاسبه شد:', data);
        // منطق سفارشی شما
    });
});
```

## عیب‌یابی (Troubleshooting)

### مشکل: فرم نمایش داده نمی‌شود

**علل احتمالی:**
1. موتور قیمت‌گذاری V2 فعال نیست
2. هیچ قطع کتابی پیکربندی نشده است

**راه‌حل:**
```php
// بررسی وضعیت موتور قیمت‌گذاری
$pricing_engine = new Tabesh_Pricing_Engine();
if (!$pricing_engine->is_enabled()) {
    echo 'موتور قیمت‌گذاری V2 فعال نیست';
}
```

### مشکل: گزینه‌ها بارگذاری نمی‌شوند

**علل احتمالی:**
1. REST API غیرفعال است
2. مشکل در احراز هویت (nonce)
3. خطا در پیکربندی ماتریس قیمت

**راه‌حل:**
1. Console مرورگر را باز کنید (F12)
2. به تب Network بروید
3. بررسی کنید که آیا درخواست‌های AJAX ارسال می‌شوند
4. بررسی کنید که آیا خطایی در Response وجود دارد

### مشکل: قیمت محاسبه نمی‌شود

**علل احتمالی:**
1. فیلدهای الزامی پر نشده‌اند
2. ترکیب پارامترها در ماتریس قیمت موجود نیست

**راه‌حل:**
1. بررسی کنید که تمام فیلدهای الزامی پر شده باشند
2. در پنل مدیریت، بررسی کنید که قیمت برای ترکیب انتخابی تعریف شده باشد

## تست‌های پیشنهادی

### تست ۱: وابستگی محدودیت‌ها

1. به پنل `قیمت‌گذاری محصول` بروید
2. برای قطع `رقعی`، کاغذ `تحریر ۶۰ گرم` را غیرمجاز کنید
3. در فرم، قطع `رقعی` را انتخاب کنید
4. **انتظار:** گزینه `تحریر ۶۰ گرم` نباید در لیست نمایش داده شود

### تست ۲: صحت قیمت

1. در پنل مدیریت، قیمت مشخصی برای یک ترکیب تعریف کنید
2. همان ترکیب را در فرم V2 انتخاب کنید
3. **انتظار:** قیمت محاسبه شده باید دقیقاً با ماتریس قیمت مطابقت داشته باشد

### تست ۳: RTL و واکنشگرا

1. فرم را در اندازه‌های مختلف صفحه بررسی کنید (دسکتاپ، تبلت، موبایل)
2. **انتظار:** 
   - همه عناصر باید راست‌چین باشند
   - فرم باید در تمام اندازه‌ها قابل استفاده باشد
   - دکمه‌ها و فیلدها باید به درستی نمایش داده شوند

### تست ۴: Object Cache

1. فرم را بارگذاری کنید و یک قطع را انتخاب کنید
2. صفحه را refresh کنید و همان قطع را دوباره انتخاب کنید
3. در Console مرورگر، باید پیام `Using cached options` را ببینید
4. **انتظار:** درخواست دوم از cache پاسخ داده شود (سریع‌تر)

## پشتیبانی و ارتقا

### مهاجرت از نسخه ۱ به نسخه ۲

نسخه ۲ به صورت کامل مستقل از نسخه ۱ طراحی شده است:

1. **هر دو فرم می‌توانند همزمان فعال باشند**
2. برای استفاده از نسخه ۲:
   - موتور قیمت‌گذاری V2 را فعال کنید
   - ماتریس قیمت را پیکربندی کنید
   - shortcode `[tabesh_order_form_v2]` را به جای `[tabesh_order_form]` استفاده کنید

### بروزرسانی‌های آینده

برنامه‌های توسعه:
- [ ] اضافه کردن قابلیت پیش‌نمایش محصول
- [ ] ذخیره پیش‌نویس سفارش برای ادامه بعدی
- [ ] پشتیبانی از چند زبان (Multi-language)
- [ ] افزودن animation‌های بهتر برای تجربه کاربری

## منابع بیشتر

- [DEPENDENCY_ENGINE_V2_GUIDE.md](./DEPENDENCY_ENGINE_V2_GUIDE.md) - راهنمای کامل موتور منطق شرطی
- [PRICING_ENGINE_V2.md](./PRICING_ENGINE_V2.md) - راهنمای موتور قیمت‌گذاری نسخه ۲
- [API.md](./API.md) - مستندات کامل REST API

## پشتیبانی

برای گزارش مشکلات یا پیشنهادات:
- GitHub Issues: [https://github.com/tabshhh3/Tabesh/issues](https://github.com/tabshhh3/Tabesh/issues)
- ایمیل پشتیبانی: support@chapco.ir

---

**نسخه:** 1.0.4
**تاریخ بروزرسانی:** دسامبر 2024
**سازگار با:** WordPress 6.8+، PHP 8.2.2+
