# ุฎูุงุตู ุฑูุน ูุดฺฉู ฺุฑุฎู ูุงุชุฑุณ ููุชโฺฏุฐุงุฑ V2

## ูุดฺฉูุงุช ุดูุงุณุง ุดุฏู ู ุฑูุน ุดุฏู โ

### 1. ุณุชูู `action` ุฏุฑ ุฌุฏูู ุงููุช ูุฌูุฏ ูุฏุงุดุช โ โ ุฑูุน ุดุฏ โ

**ูุดฺฉู**: 
- ุฌุฏูู `wp_tabesh_security_logs` ูุงูุฏ ุณุชูู `action` ุจูุฏ
- ฺฉุฏ ุฏุฑ ุจุฑุฎ ูฺฉุงูโูุง ุณุน ุฏุฑ ุฏุฑุฌ ุฏุงุฏู ุฏุฑ ุงู ุณุชูู ุฏุงุดุช โ ุฎุทุง ุฏุชุงุจุณ

**ุฑุงูโุญู**:
- ูุชุฏ `add_action_column_to_security_logs()` ุจู ฺฉูุงุณ `Tabesh_Install` ุงุถุงูู ุดุฏ
- ุงู ูุชุฏ ุฏุฑ ููฺฏุงู ูุนุงูโุณุงุฒ/ุจุฑูุฒุฑุณุงู ุงูุฒููู ุงุฌุฑุง ูโุดูุฏ
- ุณุชูู `action` ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุงุฌุงุฏ ูโุดูุฏ

**ูุงู**: `includes/core/class-tabesh-install.php` - ุฎุทูุท 440-495

---

### 2. ูุชุฏ `cleanup_corrupted_matrices()` ูุงุชุฑุณโูุง ุณุงูู ุฑุง ุญุฐู ูโฺฉุฑุฏ โ โ ุฑูุน ุดุฏ โ

**ูุดฺฉู ุงุตู**:
```php
// ฺฉุฏ ูุจู (ุงุดุชุจุงู):
if (! in_array($book_size, $valid_sizes, true)) {
    // ุงู ูุงุชุฑุณ "ูุนูุจ" ุงุณุช - ุญุฐู ุดูุฏ
    $corrupted_keys[] = $setting_key;
}
```

**ฺุฑุง ูุดฺฉู ุจูุฏุ**
1. ููฺฏุงู ฺฉู ูุฏุฑ ุจุฑุง ุจุงุฑ ุงูู ุชูุธูุงุช ุฑุง ุงูุฌุงู ูโุฏูุฏุ `$valid_sizes` ุฎุงู ุงุณุช
2. ูพุณ **ููู** ูุงุชุฑุณโูุง "ูุนูุจ" ุชูู ูโุดููุฏ
3. ููู ูุงุชุฑุณโูุง ุฐุฎุฑู ุดุฏู ุญุฐู ูโุดููุฏ!
4. ูฺ book_size ูุนุงู ุจุงู ููโูุงูุฏ

**ุฑุงูโุญู**:
```php
// ฺฉุฏ ุฌุฏุฏ (ุตุญุญ):
$decoded = base64_decode($safe_key, true);

// ููุท ุงฺฏุฑ ุฑูุฒฺฏุดุง base64 ุดฺฉุณุช ุฎูุฑุฏ ุง ูุชุฌู ูุงูุนุชุจุฑ ุงุณุช:
if (false === $decoded || empty($decoded)) {
    $corrupted_keys[] = $setting_key;
}
elseif (! $this->is_valid_book_size_string($decoded)) {
    $corrupted_keys[] = $setting_key;
}
```

**ููุทู ุฌุฏุฏ**:
- ููุท ูุงุชุฑุณโูุง ุจุง ุฑูุฒูฺฏุงุฑ base64 ูุนูุจ ุญุฐู ูโุดููุฏ
- ูุงุชุฑุณโูุง ุจุง book_size ูุงูุนุชุจุฑ (ูุซูุง ุญุงู ฺฉุงุฑุงฺฉุชุฑูุง ุบุฑูุฌุงุฒ) ุญุฐู ูโุดููุฏ
- **ููุงุณู ุจุง `book_sizes` ุงูุฌุงู ููโุดูุฏ** โ ูุงุชุฑุณโูุง ูุญููุธ ูโูุงููุฏ

**ูุงู**: `includes/handlers/class-tabesh-pricing-engine.php` - ุฎุทูุท 1304-1410

---

### 3. ูุชุฏ `cleanup_orphaned_pricing_matrices()` ุฏุฑ ูุฑ ุจุงุฑฺฏุฐุงุฑ ูุฑู ุงุฌุฑุง ูโุดุฏ โ โ ุบุฑูุนุงู ุดุฏ โ

**ูุดฺฉู**:
- ุงู ูุชุฏ ุฏุฑ ูุฑ ุจุงุฑ ุจุงุฑฺฏุฐุงุฑ ูุฑู ููุชโฺฏุฐุงุฑ ุงุฌุฑุง ูโุดุฏ
- ุฏููุง ููุงู ูุดฺฉู ุฑุง ุฏุงุดุช: ููุงุณู ุจุง `book_sizes` ุฎุงู โ ุญุฐู ููู ูุงุชุฑุณโูุง

**ุฑุงูโุญู**:
- ุงู ูุชุฏ **ฺฉุงููุง ุบุฑูุนุงู ุดุฏ**
- ุจู ุฌุง ุขูุ `migrate_mismatched_book_size_keys()` ุงุณุชูุงุฏู ูโุดูุฏ ฺฉู ููุดููุฏุชุฑ ุงุณุช
- ูพุงู log ุงุถุงูู ุดุฏ ุจุฑุง ุชูุถุญ ุฏูู ุบุฑูุนุงู ุจูุฏู

**ูุงู**: `includes/handlers/class-tabesh-product-pricing.php` - ุฎุทูุท 1056-1078

---

## ฺุฑุฎู ุตุญุญ ููุชโฺฏุฐุงุฑ (ุจุนุฏ ุงุฒ ุฑูุน ูุดฺฉู) โ

### ูุฑุงุญู ฺฉุงุฑ:

```
1. ูุฏุฑ ุจู ุชูุธูุงุช ูุญุตูู ูโุฑูุฏ
   โ
   ูุทุนโูุง ฺฉุชุงุจ ุฑุง ุชุนุฑู ูโฺฉูุฏ: ["A5", "ุฑูุน", "ูุฒุฑ"]
   โ

2. ูุฏุฑ ุจู ูุฑู ููุชโฺฏุฐุงุฑ ูโุฑูุฏ
   โ
   ููุชูุฑ V2 ุฑุง ูุนุงู ูโฺฉูุฏ
   โ
   ุจุฑุง "A5" ูุงุชุฑุณ ููุช ูโุณุงุฒุฏ (ฺฉุงุบุฐ + ุตุญุงู)
   โ
   ุฐุฎุฑู ูโฺฉูุฏ
   โ
   โ ูุงุชุฑุณ ุจุง ฺฉูุฏ normalize ุดุฏู base64 ุฐุฎุฑู ูโุดูุฏ
   โ cleanup ููุท ูุงุชุฑุณโูุง ูุนูุจ ุฑุง ุญุฐู ูโฺฉูุฏ (ูู ููู ุฑุง!)
   โ

3. Constraint Manager ูุงุชุฑุณโูุง ุฑุง ุจุฑุฑุณ ูโฺฉูุฏ
   โ
   ุงุฒ Product Parameters ูุณุช ูุทุนโูุง ุฑุง ูโฺฏุฑุฏ: ["A5", "ุฑูุน", "ูุฒุฑ"]
   โ
   ุงุฒ Pricing Engine ูุงุชุฑุณโูุง ููุฌูุฏ ุฑุง ูโฺฏุฑุฏ: ["A5"]
   โ
   ุชุทุจู ูโุฏูุฏ:
   - A5: ูุงุชุฑุณ ุฏุงุฑุฏ + ฺฉุงุบุฐ ุฏุงุฑุฏ + ุตุญุงู ุฏุงุฑุฏ โ enabled = true โ
   - ุฑูุน: ูุงุชุฑุณ ูุฏุงุฑุฏ โ enabled = false
   - ูุฒุฑ: ูุงุชุฑุณ ูุฏุงุฑุฏ โ enabled = false
   โ

4. ูุฑู ุณูุงุฑุด V2 ุจุงุฑฺฏุฐุงุฑ ูโุดูุฏ
   โ
   ููุท "A5" ููุงุด ุฏุงุฏู ูโุดูุฏ (enabled) โ
   โ
   ฺฉุงุฑุจุฑ ูโุชูุงูุฏ ุณูุงุฑุด ุซุจุช ฺฉูุฏ โ
```

### ูุจู ุงุฒ ุฑูุน (ฺุฑุฎู ูุนูุจ):

```
ูุฏุฑ ูุงุชุฑุณ ุฑุง ุฐุฎุฑู ูโฺฉูุฏ
  โ
cleanup ุงุฌุฑุง ูโุดูุฏ
  โ
book_sizes ุฎุงู ุงุณุช ุง ุฏุฑ ุญุงู ูพฺฉุฑุจูุฏ
  โ
ููู ูุงุชุฑุณโูุง "ุชู" ุชุดุฎุต ุฏุงุฏู ูโุดููุฏ
  โ
โ ููู ูุงุชุฑุณโูุง ุญุฐู ูโุดููุฏ
  โ
ูุฑู ุณูุงุฑุด ูฺ book_size ูุนุงู ูุฏุงุฑุฏ โ
```

### ุจุนุฏ ุงุฒ ุฑูุน (ฺุฑุฎู ุณุงูู):

```
ูุฏุฑ ูุงุชุฑุณ ุฑุง ุฐุฎุฑู ูโฺฉูุฏ
  โ
cleanup ููุท ุฏุงุฏูโูุง ูุงูุนุง ูุนูุจ ุฑุง ุจุฑุฑุณ ูโฺฉูุฏ
  โ
ูุงุชุฑุณโูุง ุณุงูู ูุญููุธ ูโูุงููุฏ โ
  โ
Constraint Manager ูุงุชุฑุณโูุง ุฑุง ูพุฏุง ูโฺฉูุฏ โ
  โ
ูุฑู ุณูุงุฑุด book_size ูุง ูุนุงู ุฑุง ููุงุด ูโุฏูุฏ โ
```

---

## ุฑุงูููุง ุชุณุช

### ุชุณุช 1: ูุตุจ ุชุงุฒู โ

```bash
# 1. ุงูุฒููู ุฑุง ูุตุจ/ูุนุงู ฺฉูุฏ
# 2. ุจู ุชูุธูุงุช โ ูุญุตููุงุช ุจุฑูุฏ
#    ูุทุนโูุง ุฑุง ุงุถุงูู ฺฉูุฏ: A5, ุฑูุน, ูุฒุฑ

# 3. ุจู ูุฏุฑุช ููุชโฺฏุฐุงุฑ ูุญุตููุงุช ุจุฑูุฏ
#    ููุชูุฑ V2 ุฑุง ูุนุงู ฺฉูุฏ

# 4. ุจุฑุง A5 ูุงุชุฑุณ ููุช ฺฉุงูู ุชูุธู ฺฉูุฏ:
#    - ฺฉุงุบุฐูุง: ุชุญุฑุฑ 70ุ ุจุงูฺฉ 80ุ ...
#    - ุตุญุงูโูุง: ุดููุฒุ ุณูุ ...
#    - ุฐุฎุฑู ฺฉูุฏ

# 5. ูุฑู ุณูุงุฑุด V2 ุฑุง ุจุงุฒ ฺฉูุฏ
#    ุงูุชุธุงุฑ: A5 ุจุงุฏ ุฏุฑ ูุณุช ูุทุนโูุง ูุงุจู ุงูุชุฎุงุจ ุจุงุดุฏ โ
```

### ุชุณุช 2: ุจุงุฒูพฺฉุฑุจูุฏ โ

```bash
# 1. ุจุง ูุงุชุฑุณโูุง ููุฌูุฏ
# 2. ุจู ุชูุธูุงุช ูุญุตูู ุจุฑูุฏ
#    ฺฉ ูุทุน ุฑุง ูููุชุง ุญุฐู ฺฉูุฏ (ูุซูุง ุฑูุน)
#    ุฐุฎุฑู ฺฉูุฏ

# 3. ุฏูุจุงุฑู ููุงู ูุทุน ุฑุง ุงุถุงูู ฺฉูุฏ
#    ุฐุฎุฑู ฺฉูุฏ

# 4. ุจู ูุฑู ููุชโฺฏุฐุงุฑ ุจุฑูุฏ
#    ุงูุชุธุงุฑ: ูุงุชุฑุณ ูุจู ุฑูุน ููฺูุงู ูุฌูุฏ ุฏุงุฑุฏ โ
#    (ุญุฐู ูุดุฏู ุงุณุช)
```

### ุชุณุช 3: ูุงฺฏุฑุดู ฺฉูุฏูุง ูุฏู โ

```bash
# ุงฺฏุฑ ูุงุชุฑุณโูุง ูุฏู ุจุง ุชูุถุญุงุช ุฏุงุฑุฏ:
# ูุซูุง: "ุฑูุน (14ร20)"

# 1. ูุฑู ููุชโฺฏุฐุงุฑ ุฑุง ุจุงุฒ ฺฉูุฏ
#    ุงูุชุธุงุฑ: ูพุงู ููููุช migration ููุงุด ุฏุงุฏู ูโุดูุฏ
#    "โ ุงุตูุงุญ ุฎูุฏฺฉุงุฑ ูุงุชุฑุณโูุง ููุช"

# 2. ฺฉูุฏูุง normalize ูโุดููุฏ: "ุฑูุน (14ร20)" โ "ุฑูุน"
# 3. ูุงุชุฑุณโูุง ุงุฏุบุงู ูโุดููุฏ
# 4. ูุทุนโูุง ูุนุงู ูโุดููุฏ
```

---

## ูุงฺฏโูุง ููุฏ ุจุฑุง ุฏุจุงฺฏ

ุฏุฑ ุญุงูุช `WP_DEBUG = true`ุ ุงู ูพุงูโูุง ุฏุฑ `wp-content/debug.log` ุซุจุช ูโุดููุฏ:

### ูุงฺฏโูุง ููููุช:
```
Tabesh: SUCCESS - Added action column to security_logs table
Tabesh: Cleanup complete - No corrupted matrices found
Tabesh: Size "A5" is USABLE and ENABLED - 3 papers, 2 bindings
Tabesh Constraint Manager: Returning 3 total sizes (1 enabled, 2 disabled)
```

### ูุงฺฏโูุง ูุดุฏุงุฑ (ูุฑูุงู):
```
Tabesh: cleanup_orphaned_pricing_matrices disabled - using migrate_mismatched_book_size_keys instead
Tabesh: Size "ุฑูุน" exists in product parameters but has no pricing matrix
```

### ูุงฺฏโูุง ุฎุทุง (ูุงุฒ ุจู ุฑุณุฏฺฏ):
```
Tabesh: ERROR - Failed to add action column: [error message]
Tabesh: Found corrupted pricing matrix with invalid encoding
```

---

## ูฺฉุงุช ุงููุช โ

ููู ุชุบุฑุงุช:
- โ ุงุฒ prepared statements ุงุณุชูุงุฏู ูโฺฉููุฏ
- โ ูุฑูุฏโูุง sanitize ูโุดููุฏ
- โ ุฎุฑูุฌโูุง escape ูโุดููุฏ
- โ nonce verification ุฏุณุช ูุฎูุฑุฏู ุจุงู ูุงูุฏู
- โ ููุท ุฏุงุฏูโูุง ูุงูุนุง ูุนูุจ (ุฑูุฒูฺฏุงุฑ ูุงูุนุชุจุฑ) ุญุฐู ูโุดููุฏ

---

## ุฎูุงุตู ุชุบุฑุงุช ูุงูโูุง

| ูุงู | ุชุบุฑ | ุฏูู |
|------|-------|------|
| `class-tabesh-install.php` | ุงูุฒูุฏู ูุชุฏ `add_action_column_to_security_logs()` | ุฑูุน ุฎุทุง ุฏุชุงุจุณ |
| `class-tabesh-pricing-engine.php` | ุงุตูุงุญ ููุทู `cleanup_corrupted_matrices()` | ุญูุธ ูุงุชุฑุณโูุง ุณุงูู |
| `class-tabesh-product-pricing.php` | ุบุฑูุนุงู ฺฉุฑุฏู `cleanup_orphaned_pricing_matrices()` | ุฌููฺฏุฑ ุงุฒ ุญุฐู ุงุดุชุจุงู |

---

## ูุชุฌู ููุง โ

ุจุง ุงู ุชุบุฑุงุช:

1. โ ุณุชูู `action` ุฏุฑ ุฌุฏูู ุงููุช ูุฌูุฏ ุฏุงุฑุฏ โ ุฎุทุง ุฏุชุงุจุณ ุฑูุน ุดุฏ
2. โ ูุงุชุฑุณโูุง ููุช ุญูุธ ูโุดููุฏ โ ุญุฐู ุงุดุชุจุงู ุฑุฎ ููโุฏูุฏ
3. โ book_size ูุง ุจุนุฏ ุงุฒ ุฐุฎุฑู ููุช ูุนุงู ูโุดููุฏ โ ุฏุฑ ูุฑู V2 ููุงุด ุฏุงุฏู ูโุดููุฏ
4. โ ฺฉุด ุจู ุฏุฑุณุช invalidate ูโุดูุฏ โ ุฏุงุฏูโูุง ูุฏู ุงุณุชูุงุฏู ููโุดููุฏ
5. โ ฺุฑุฎู ฺฉุงูู ููุชโฺฏุฐุงุฑ ู ุซุจุช ุณูุงุฑุด ุณุงูู ุงุณุช

**ฺุฑุฎู V2 ุงฺฉููู ฺฉุงููุง ุนููุงุช ุงุณุช! ๐**
