# خلاصه رفع مشکلات فرم قیمت‌گذاری نسخه 2

## مشکلات برطرف شده

### مشکل 1: کلیدهای فعال/غیرفعال سازی برای گرماژ کاغذ
**وضعیت:** ✅ حل شده

**توضیحات:**
فرم قیمت‌گذاری مدیریتی از قبل دارای کلیدهای فعال/غیرفعال سازی برای **هر دو** نوع چاپ تک‌رنگ و رنگی برای هر گرماژ کاغذ بود. اما محدودیت‌ها به درستی در فرم‌های فرانت‌اند اعمال نمی‌شدند.

**آنچه رفع شد:**
1. منطق فیلتر کردن انواع کاغذی که **هر دو** نوع چاپ تک‌رنگ و رنگی در آن‌ها غیرفعال است اضافه شد (این کاغذها اصلاً در لیست‌ها نمایش داده نمی‌شوند)
2. منطق فیلتر کردن انواع صحافی غیرفعال شده اضافه شد
3. محدودیت‌ها در هر دو فرم سفارش مشتری و فرم سفارش مدیر اعمال می‌شوند

**فایل‌های تغییر یافته:**
- `tabesh.php` (خطوط 2330-2365): فیلتر محدودیت‌ها هنگام ساخت داده‌های JavaScript
- `includes/handlers/class-tabesh-admin-order-form.php` (خطوط 173-218): همان فیلتر برای فرم مدیر

### مشکل 2: لود نشدن گرماژ کاغذ در فرم
**وضعیت:** ✅ حل شده

**علت اصلی:**
زمانی که موتور قیمت‌گذاری V2 فعال است، گرماژهای کاغذ مخصوص هر قطع کتاب هستند. تابع JavaScript وقتی کاربر نوع کاغذ را **قبل از** انتخاب قطع کتاب انتخاب می‌کرد، گرماژ را نمایش نمی‌داد و فرم کار نمی‌کرد.

**آنچه رفع شد:**
1. تابع `updatePaperWeights()` بهبود یافت و حالا پیام مناسب نمایش می‌دهد
2. پیام‌های خطا برای حالت‌های مختلف اضافه شد
3. تابع `updatePaperWeightsV2()` با مدیریت خطای کامل بهبود یافت
4. لاگ‌های کنسول برای رفع اشکال اضافه شدند

**فایل‌های تغییر یافته:**
- `assets/js/frontend.js` (خطوط 204-232): بهبود مدیریت خطا و بازخورد کاربر

**پیام‌های خطای اضافه شده:**
- "لطفاً ابتدا قطع کتاب را انتخاب کنید" - اگر قطع انتخاب نشده باشد
- "هیچ گرماژی برای این کاغذ تعریف نشده است" - اگر گرماژی موجود نباشد
- "این نوع کاغذ برای قطع انتخابی موجود نیست" - اگر کاغذ برای قطع مجاز نباشد
- "خطا: ماتریس قیمت‌گذاری یافت نشد" - خطای سیستمی

## جزئیات فنی

### منطق فیلتر محدودیت‌ها

هنگام ساخت ساختار داده `v2PricingMatrices` برای JavaScript، کد حالا:

1. **بررسی انواع کاغذ کاملاً غیرمجاز:** اگر نوع کاغذی در آرایه `forbidden_paper_types` باشد، کلاً حذف می‌شود
2. **بررسی محدودیت‌های جزئی:** اگر **هر دو** نوع چاپ تک‌رنگ و رنگی برای یک کاغذ غیرمجاز باشند، آن کاغذ حذف می‌شود
3. **شامل کردن کاغذهای نیمه‌مجاز:** اگر حداقل یک نوع چاپ (تک‌رنگ **یا** رنگی) مجاز باشد، کاغذ نمایش داده می‌شود
4. **فیلتر انواع صحافی:** صحافی‌های غیرمجاز از لیست حذف می‌شوند

### جریان داده

```
فرم قیمت‌گذاری مدیر (product-pricing.php)
    ↓
محدودیت‌ها در دیتابیس ذخیره می‌شوند (wp_tabesh_settings)
    ↓
PHP ساختار v2PricingMatrices را با اعمال محدودیت‌ها می‌سازد
    ↓
داده‌ها از طریق wp_localize_script به JavaScript پاس داده می‌شوند
    ↓
فرم‌های فرانت‌اند فقط گزینه‌های مجاز را نمایش می‌دهند
```

### ترتیب انتخاب در حالت V2

زمانی که موتور قیمت‌گذاری V2 فعال است، ترتیب صحیح انتخاب:
1. **قطع کتاب** - باید اول انتخاب شود
2. **نوع کاغذ** - انواع موجود بر اساس قطع کتاب فیلتر می‌شوند
3. **گرماژ کاغذ** - گرماژهای موجود بر اساس قطع و نوع کاغذ فیلتر می‌شوند
4. **نوع چاپ** - ممکن است بر اساس نوع کاغذ محدود شود
5. **نوع صحافی** - انواع موجود بر اساس قطع کتاب فیلتر می‌شوند

این با حالت V1 متفاوت است که در آن انواع و گرماژهای کاغذ سراسری (global) هستند و به قطع کتاب وابسته نیستند.

## توصیه‌های تست

### تست 1: عملکرد کلیدها در فرم قیمت‌گذاری مدیر
1. به فرم قیمت‌گذاری با شورتکد `[tabesh_product_pricing]` بروید
2. موتور قیمت‌گذاری V2 را فعال کنید (اگر فعال نیست)
3. یک قطع کتاب انتخاب کنید
4. برای هر نوع کاغذ، کلیدهای تک‌رنگ و رنگی را برای گرماژهای مختلف تست کنید
5. تنظیمات را ذخیره کنید
6. بررسی کنید محدودیت‌ها در دیتابیس ذخیره شده‌اند

### تست 2: اعمال محدودیت‌ها در فرم سفارش مشتری
1. به فرم سفارش مشتری با شورتکد `[tabesh_order_form]` بروید
2. مطمئن شوید V2 فعال است
3. یک قطع کتاب انتخاب کنید
4. بررسی کنید فقط انواع کاغذ مجاز در لیست نمایش داده می‌شوند
5. یک نوع کاغذ انتخاب کنید
6. بررسی کنید فقط گرماژهای مجاز در لیست نمایش داده می‌شوند
7. محاسبه قیمت را تست کنید

### تست 3: فرم سفارش مدیر - همان محدودیت‌ها
1. به فرم سفارش مدیر با شورتکد `[tabesh_admin_order_form]` بروید
2. بررسی کنید همان محدودیت‌های فرم مشتری اعمال می‌شوند
3. تست کنید گزینه‌های غیرفعال نمایش داده نمی‌شوند
4. محاسبه قیمت با محدودیت‌ها را تست کنید

### تست 4: مدیریت خطا
1. با V2 فعال، سعی کنید نوع کاغذ را **قبل از** قطع کتاب انتخاب کنید
2. بررسی کنید این پیام نمایش داده می‌شود: "لطفاً ابتدا قطع کتاب را انتخاب کنید"
3. قطع کتاب و سپس نوع کاغذ را انتخاب کنید
4. بررسی کنید گرماژها به درستی نمایش داده می‌شوند

### تست 5: سازگاری با V1
1. موتور قیمت‌گذاری V2 را غیرفعال کنید
2. بررسی کنید فرم سفارش مشتری با قیمت‌گذاری V1 کار می‌کند
3. بررسی کنید گرماژهای کاغذ در حالت V1 به درستی لود می‌شوند
4. بررسی کنید محدودیتی اعمال نمی‌شود (V1 از محدودیت‌ها پشتیبانی نمی‌کند)

## ملاحظات امنیتی

تمام تغییرات رویه‌های امنیتی وردپرس را رعایت می‌کنند:
- ✅ پاکسازی ورودی‌ها با `sanitize_text_field()`، `sanitize_key()`، `intval()`
- ✅ Escape کردن خروجی‌ها در قالب‌ها (از قبل موجود بود)
- ✅ کوئری‌های دیتابیس از `$wpdb->prepare()` استفاده می‌کنند
- ✅ هیچ آسیب‌پذیری امنیتی جدیدی اضافه نشده
- ✅ فیلتر محدودیت‌ها از تزریق گزینه‌های غیرمجاز جلوگیری می‌کند

## تاثیر بر عملکرد

تاثیر بسیار اندک بر عملکرد:
- فیلتر محدودیت‌ها سربار کمی هنگام ساخت v2PricingMatrices اضافه می‌کند
- این فقط یک بار در هر بارگذاری صفحه زمانی که `wp_enqueue_scripts` اجرا می‌شود، اتفاق می‌افتد
- داده‌های فیلتر شده در JavaScript کش می‌شوند، نیازی به فراخوانی API اضافی نیست
- هیچ تاثیری بر عملکرد محاسبه قیمت ندارد

## سازگاری با نسخه‌های قبلی

- ✅ موتور قیمت‌گذاری V1 بدون تغییر کار می‌کند
- ✅ سفارشات موجود تحت تاثیر قرار نمی‌گیرند
- ✅ مدیر می‌تواند هر زمان بین V1 و V2 جابه‌جا شود
- ✅ نیازی به تغییر ساختار دیتابیس نیست
- ✅ هیچ تغییر شکننده‌ای در REST API نیست

## بهبودهای آینده

پیشنهاداتی برای نسخه‌های آینده:

1. **نشانگرهای بصری:** افزودن بازخورد بصری در فرم قیمت‌گذاری که نشان دهد کدام کاغذها/گرماژها دارای محدودیت هستند
2. **محدودیت‌های گروهی:** امکان تنظیم محدودیت برای چند قطع کتاب همزمان
3. **ورود/خروج:** قابلیت خروجی/ورودی تنظیمات محدودیت‌ها
4. **الگوهای محدودیت:** الگوهای رایج محدودیت (مثلاً "بدون چاپ رنگی برای کتاب‌های بیش از 200 صفحه")
5. **هشدارهای مدیر:** هشدار به مدیر هنگام ایجاد محدودیت‌هایی که ممکن است برخی قطع‌ها را غیرقابل چاپ کند

## پشتیبانی

برای مشکلات مرتبط با این رفع‌ها:
1. کنسول مرورگر را برای خطاهای JavaScript بررسی کنید
2. WP_DEBUG را فعال کنید تا لاگ‌های جزئی خطا را ببینید
3. بررسی کنید ماتریس‌های قیمت‌گذاری V2 در دیتابیس به درستی تنظیم شده‌اند
4. مطمئن شوید انواع کاغذ حداقل یک نوع چاپ مجاز (تک‌رنگ یا رنگی) دارند
5. کش مرورگر را پس از به‌روزرسانی پاک کنید

---

**نسخه:** 1.0.4  
**آخرین به‌روزرسانی:** دسامبر 2024  
**توسعه‌دهنده:** تیم توسعه تابش
